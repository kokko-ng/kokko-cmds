# Verify and Fix Anki Flashcards

Verify the accuracy of generated Anki flashcards against the actual codebase and fix any issues directly in the JSON file.

## Prerequisites

- Anki cards must exist at `codemap/<system-id>/anki-cards.json` (generated by `/viz/anki-generate`)
- C4 architecture map must exist in `codemap/<system-id>/`

## Orchestration

```
Phase 1: Preparation --> Phase 2: Parallel Batch Verification --> Phase 3: Merge Corrections
```

Phase 2 splits cards into batches and verifies them in parallel against the actual codebase.

---

## Phase 1: Preparation

Load cards and split into batches for parallel verification.

```bash
# Find system folder and cards file
SYSTEM_ID=$(ls codemap/ | grep -v "README.md" | grep -v ".json" | head -1)
echo "System ID: $SYSTEM_ID"

# Verify cards file exists
ls -la codemap/$SYSTEM_ID/anki-cards.json

# Count total cards
python3 -c "import json; cards=json.load(open('codemap/$SYSTEM_ID/anki-cards.json')); print(f'Total cards: {len(cards)}')"
```

Read the cards file and split into batches of ~20-25 cards each:

```python
import json
cards = json.load(open(f'codemap/{SYSTEM_ID}/anki-cards.json'))
batch_size = 25
batches = [cards[i:i+batch_size] for i in range(0, len(cards), batch_size)]
print(f"Split into {len(batches)} batches")
```

---

## Phase 2: Parallel Batch Verification

Launch verification subagents IN PARALLEL, one per batch.

For each batch, spawn a subagent:

```
Tool: Task
Parameters:
  subagent_type: "Explore"
  description: "Verify Anki batch N"
  prompt: |
    TASK: Verify accuracy of Anki cards batch N against the actual codebase.

    BATCH NUMBER: N
    CARDS TO VERIFY:
    ```json
    <insert batch N cards here, with index numbers>
    [
      {"index": 0, "Front": "...", "Back": "..."},
      {"index": 1, "Front": "...", "Back": "..."},
      ...
    ]
    ```

    VERIFICATION PROCESS:

    For EACH card, check:

    1. FACTUAL ACCURACY:
       - Is the Back (answer) correct for the Front (definition)?
       - Search the codebase to verify claims
       - Check codemap documentation matches actual code

    2. TERMINOLOGY ACCURACY:
       - Does the term/name in Back actually exist?
       - Is it spelled correctly?
       - Is the casing correct (PascalCase, camelCase, kebab-case)?

    3. DEFINITION QUALITY:
       - Is the Front clear and unambiguous?
       - Does Front accidentally contain the answer?
       - Is there only ONE correct answer for this Front?

    4. RELEVANCE:
       - Is this concept actually part of this codebase?
       - Is the card specific enough to be useful?
       - Would a senior dev on this project need to know this?

    SEARCH STRATEGY:
    - Grep for class names, function names, patterns mentioned in Back
    - Read relevant source files to verify descriptions
    - Check codemap/*.md files for documented concepts
    - Verify relationships and dependencies exist

    VERIFICATION RESULTS:

    For each card, determine:
    - CORRECT: Card is accurate, keep as-is
    - FIX: Card has fixable issues, provide correction
    - DELETE: Card is wrong/irrelevant, mark for removal

    OUTPUT FORMAT:
    ```json
    {
      "batch_number": N,
      "cards_verified": <count>,
      "results": [
        {
          "index": 0,
          "status": "correct",
          "original": {"Front": "...", "Back": "..."}
        },
        {
          "index": 5,
          "status": "fix",
          "original": {"Front": "...", "Back": "..."},
          "corrected": {"Front": "...", "Back": "..."},
          "reason": "Class name is AuthHandler not AuthService",
          "evidence": "Found in src/auth/handler.py:15"
        },
        {
          "index": 12,
          "status": "delete",
          "original": {"Front": "...", "Back": "..."},
          "reason": "This component doesn't exist in the codebase",
          "evidence": "Searched for 'MetricsCollector' - not found"
        }
      ],
      "summary": {
        "correct": <count>,
        "fixed": <count>,
        "deleted": <count>
      }
    }
    ```

    IMPORTANT:
    - Verify EVERY card in the batch
    - Provide evidence for all fixes and deletions
    - For fixes, provide the complete corrected card
    - Be precise with terminology and spelling
```

**Launch all batch verification subagents in parallel in a single message.**

Example for 4 batches - launch all 4 Task tools simultaneously:

```
Tool: Task (Batch 1 - cards 0-24)
Tool: Task (Batch 2 - cards 25-49)
Tool: Task (Batch 3 - cards 50-74)
Tool: Task (Batch 4 - cards 75-99)
```

**WAIT for ALL batch subagents to complete before proceeding to Phase 3.**

---

## Phase 3: Merge Corrections and Update JSON

Collect all verification results and apply corrections to the JSON file.

### Step 3A: Merge Results

Combine all batch results:

```python
# Pseudocode for merging
all_results = []
for batch in batch_results:
    all_results.extend(batch["results"])

# Sort by index to maintain order
all_results.sort(key=lambda x: x["index"])

# Categorize
correct_cards = [r for r in all_results if r["status"] == "correct"]
fixed_cards = [r for r in all_results if r["status"] == "fix"]
deleted_indices = [r["index"] for r in all_results if r["status"] == "delete"]
```

### Step 3B: Build Corrected Card List

```python
# Start with original cards
original_cards = json.load(open(f'codemap/{SYSTEM_ID}/anki-cards.json'))

# Apply corrections
final_cards = []
for i, card in enumerate(original_cards):
    if i in deleted_indices:
        continue  # Skip deleted cards

    # Check if this card was fixed
    fix = next((r for r in fixed_cards if r["index"] == i), None)
    if fix:
        final_cards.append(fix["corrected"])
    else:
        final_cards.append(card)
```

### Step 3C: Write Updated JSON

Write the corrected cards back to `codemap/<system-id>/anki-cards.json`:

```python
with open(f'codemap/{SYSTEM_ID}/anki-cards.json', 'w') as f:
    json.dump(final_cards, f, indent=2)
```

### Step 3D: Verify Output

```bash
# Validate JSON syntax
python3 -c "import json; json.load(open('codemap/$SYSTEM_ID/anki-cards.json'))" && echo "Valid JSON"

# Count final cards
python3 -c "import json; cards=json.load(open('codemap/$SYSTEM_ID/anki-cards.json')); print(f'Final cards: {len(cards)}')"
```

---

## Output Summary

Report the verification results to the user:

```markdown
# Anki Card Verification Complete

## System: <system-id>

## Verification Summary
| Metric | Count |
|--------|-------|
| Total cards verified | X |
| Correct (unchanged) | Y |
| Fixed | Z |
| Deleted | W |
| **Final card count** | **N** |

## Corrections Applied

### Fixed Cards (Z total)
| # | Original Back | Corrected Back | Reason |
|---|---------------|----------------|--------|
| 1 | AuthService | AuthHandler | Class name corrected |
| 2 | ... | ... | ... |

### Deleted Cards (W total)
| # | Back | Reason |
|---|------|--------|
| 1 | MetricsCollector | Component doesn't exist |
| 2 | ... | ... |

## Updated File
`codemap/<system-id>/anki-cards.json` has been updated with all corrections.
```

---

## Error Handling

**If cards file doesn't exist:**
- Report that `/viz/anki-generate` must be run first
- Exit without changes

**If batch verification fails:**
- Report which batch failed
- Continue with other batches
- Note incomplete verification in summary

**If all batches report issues:**
- Apply all valid corrections
- Suggest re-running `/viz/anki-generate` with updated codemap

**If JSON write fails:**
- Report the error
- Output corrected JSON to stdout as backup
