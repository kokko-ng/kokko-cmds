# Generate Anki Flashcards from Code Map

Generate a comprehensive JSON file containing Anki flashcards covering all concepts a senior developer on this project should know, based on the C4 architecture documentation in `codemap/`.

## Prerequisites

A C4 architecture map must exist in `codemap/<system-id>/` (generated by `/viz/c4-map`).

## Orchestration

```
Phase 1: Preparation --> Phase 2: Parallel Content Extraction --> Phase 3: Synthesis --> Phase 4: Write JSON
```

Phase 2 extracts cards in parallel from three sources: Context & External Systems, Containers & Technology, and Components & Code.

## Card Structure

```json
[
  {
    "Front": "<Definition or explanation of a concept without explicitly stating the term>",
    "Back": "<Correct term or answer>"
  }
]
```

## Card Requirements

### Card Format
- **Front**: Clear, concise definition or explanation WITHOUT mentioning the term itself
- **Back**: The exact term, component name, pattern, or concept

### Content Coverage

Generate cards for ALL of the following categories found in the codemap:

**System Architecture**:
- System purpose and boundaries
- External system integrations
- Actor/user types
- High-level data flows

**Container Knowledge**:
- Container responsibilities
- Technology stack per container
- Inter-container communication protocols
- Deployment boundaries

**Component Knowledge**:
- Component responsibilities
- Module boundaries
- Internal vs cross-container dependencies
- Interface contracts

**Code-Level Knowledge**:
- Key class purposes
- Design patterns used
- Class relationships (inheritance, composition)
- Important method responsibilities

**Cross-Cutting Concepts**:
- Authentication/authorization patterns
- Error handling approaches
- Configuration management
- Logging/observability patterns
- Testing strategies

---

## Phase 1: Preparation

Discover the system and gather context.

```bash
# Find the system folder
SYSTEM_ID=$(ls codemap/ | grep -v "README.md" | grep -v ".json" | head -1)
echo "System ID: $SYSTEM_ID"

# List all documentation files
find codemap/$SYSTEM_ID -name "*.md" | sort

# Count elements at each level
echo "Context: 1"
echo "Containers: $(find codemap/$SYSTEM_ID/containers -maxdepth 1 -type d 2>/dev/null | wc -l)"
echo "Components: $(find codemap/$SYSTEM_ID -type d -name components -exec ls {} \; 2>/dev/null | wc -l)"
echo "Code docs: $(find codemap/$SYSTEM_ID -type d -name code 2>/dev/null | wc -l)"
```

Read key files to understand scope:
- `codemap/<system-id>/context.md`
- Sample container, component, and code documentation files

---

## Phase 2: Parallel Content Extraction

Launch THREE content extraction subagents IN PARALLEL.

### Subagent 1: Context & External Systems

```
Tool: Task
Parameters:
  subagent_type: "Explore"
  description: "Extract context cards"
  prompt: |
    TASK: Extract Anki card content from SYSTEM CONTEXT documentation.

    SYSTEM_ID: <from Phase 0>

    FILES TO READ:
    - codemap/<system-id>/context.md
    - codemap/<system-id>/context.puml

    EXTRACT CARDS FOR:

    1. SYSTEM PURPOSE:
       - What does this system do?
       - What problem does it solve?
       - Who uses it?

    2. EXTERNAL SYSTEMS:
       - For each external system: what is it and why is it used?
       - Integration patterns with each external system
       - Data exchanged with external systems

    3. ACTORS:
       - For each actor type: their role and interactions
       - Access patterns
       - Authorization levels if documented

    4. SYSTEM BOUNDARIES:
       - What's inside vs outside the system
       - Key interfaces exposed

    CARD FORMAT RULES:
    - Front: Definition/explanation WITHOUT the term
    - Back: The specific term, system name, or concept
    - Make cards specific to THIS project, not generic definitions

    EXAMPLE CARDS:
    {
      "Front": "The external AI service this system uses for natural language processing and embedding generation",
      "Back": "Azure OpenAI"
    },
    {
      "Front": "The user role that consumes the REST API to integrate chat functionality into third-party applications",
      "Back": "API Consumer"
    }

    OUTPUT FORMAT:
    ```json
    {
      "category": "context",
      "card_count": <number>,
      "cards": [
        {"Front": "...", "Back": "..."},
        ...
      ]
    }
    ```
```

### Subagent 2: Containers & Technology Stack

```
Tool: Task
Parameters:
  subagent_type: "Explore"
  description: "Extract container cards"
  prompt: |
    TASK: Extract Anki card content from CONTAINER documentation.

    SYSTEM_ID: <from Phase 0>

    FILES TO READ:
    - All container.md files in codemap/<system-id>/containers/*/
    - All container.puml files

    EXTRACT CARDS FOR:

    1. CONTAINER PURPOSES:
       - What each container does
       - Why it exists as a separate deployable unit
       - Its core responsibility

    2. TECHNOLOGY STACK:
       - Framework used by each container
       - Runtime environment
       - Key libraries/dependencies

    3. INTER-CONTAINER COMMUNICATION:
       - How containers communicate (protocols)
       - Which containers depend on which
       - Synchronous vs asynchronous patterns

    4. CONTAINER BOUNDARIES:
       - What lives in each container
       - How work is distributed across containers

    CARD FORMAT RULES:
    - Front: Definition/explanation WITHOUT the term
    - Back: The specific container name, technology, or pattern
    - Include container-specific details

    EXAMPLE CARDS:
    {
      "Front": "The container responsible for handling all HTTP requests, authentication, and routing in the system",
      "Back": "API Server"
    },
    {
      "Front": "The web framework used by the API Server container for building async REST endpoints",
      "Back": "FastAPI"
    },
    {
      "Front": "The communication protocol used between the API Server and Chat Database containers",
      "Back": "SQL over TCP"
    }

    OUTPUT FORMAT:
    ```json
    {
      "category": "containers",
      "card_count": <number>,
      "cards": [
        {"Front": "...", "Back": "..."},
        ...
      ]
    }
    ```
```

### Subagent 3: Components & Code Patterns

```
Tool: Task
Parameters:
  subagent_type: "Explore"
  description: "Extract component cards"
  prompt: |
    TASK: Extract Anki card content from COMPONENT and CODE documentation.

    SYSTEM_ID: <from Phase 0>

    FILES TO READ:
    - All component.md files in codemap/<system-id>/**/components/*/
    - All component.puml files
    - All classes.md files in codemap/<system-id>/**/code/
    - All classes.puml files

    EXTRACT CARDS FOR:

    1. COMPONENT RESPONSIBILITIES:
       - What each component handles
       - Its single responsibility
       - Module boundaries

    2. COMPONENT DEPENDENCIES:
       - Internal dependencies (same container)
       - Cross-container dependencies
       - Why these dependencies exist

    3. KEY CLASSES:
       - Purpose of each key class
       - What problem it solves
       - Its role in the component

    4. DESIGN PATTERNS:
       - Patterns used and where
       - Why each pattern was chosen
       - How patterns are implemented

    5. CLASS RELATIONSHIPS:
       - Inheritance hierarchies
       - Composition relationships
       - Interface implementations

    6. IMPORTANT METHODS:
       - Key public methods and their purposes
       - Critical algorithms or logic

    CARD FORMAT RULES:
    - Front: Definition/explanation WITHOUT the term
    - Back: The specific component, class, pattern, or method name
    - Be specific to this codebase

    EXAMPLE CARDS:
    {
      "Front": "The component responsible for validating JWT tokens and managing user sessions in the API Server",
      "Back": "Authentication Module"
    },
    {
      "Front": "The class that implements token creation and validation using RS256 signing",
      "Back": "JWTHandler"
    },
    {
      "Front": "The design pattern used by JWTHandler to create different token types (access, refresh, API key)",
      "Back": "Factory Pattern"
    },
    {
      "Front": "The relationship between BasicAuthMiddleware and JWTHandler where the middleware delegates token validation",
      "Back": "Composition / Delegation"
    }

    OUTPUT FORMAT:
    ```json
    {
      "category": "components_and_code",
      "card_count": <number>,
      "cards": [
        {"Front": "...", "Back": "..."},
        ...
      ]
    }
    ```
```

**WAIT for ALL THREE subagents to complete before proceeding to Phase 3.**

---

## Phase 3: Synthesis and Deduplication

Merge and deduplicate cards from all subagents.

```
Tool: Task
Parameters:
  subagent_type: "general-purpose"
  model: "opus"
  description: "Synthesize Anki cards"
  prompt: |
    TASK: Synthesize and deduplicate Anki cards from all extraction phases.

    EXTRACTED CARDS:
    - Context cards: <insert full output from Subagent 1>
    - Container cards: <insert full output from Subagent 2>
    - Component/Code cards: <insert full output from Subagent 3>

    SYNTHESIS GOALS:

    1. REMOVE DUPLICATES:
       - Cards with same or very similar Fronts
       - Cards with same Backs but different Front phrasings (keep best one)
       - Near-duplicate concepts

    2. ENSURE QUALITY:
       - Front NEVER contains the Back answer
       - Front is clear and unambiguous
       - Back is concise (1-5 words typically)
       - Cards are specific to THIS project

    3. BALANCE COVERAGE:
       - Ensure representation across all C4 levels
       - No single category dominates
       - Important concepts have cards

    4. IMPROVE CLARITY:
       - Rewrite unclear Fronts
       - Make definitions more precise
       - Ensure single correct answer per card

    5. ADD MISSING CONCEPTS:
       - Cross-cutting concerns (error handling, logging, config)
       - Relationships between levels
       - Key decisions/tradeoffs documented

    OUTPUT FORMAT:
    ```json
    {
      "synthesis_summary": {
        "input_cards": {
          "context": <count>,
          "containers": <count>,
          "components_and_code": <count>,
          "total_input": <count>
        },
        "duplicates_removed": <count>,
        "cards_improved": <count>,
        "final_count": <count>
      },
      "cards_by_category": {
        "context": <count>,
        "containers": <count>,
        "components": <count>,
        "code_patterns": <count>,
        "cross_cutting": <count>
      },
      "final_cards": [
        {"Front": "...", "Back": "..."},
        ...
      ]
    }
    ```
```

---

## Phase 4: Write JSON Output

Write the final JSON file to the codemap folder.

### Step 4A: Create the Anki JSON file

Write the `final_cards` array from Phase 3 to `codemap/<system-id>/anki-cards.json`:

```json
[
  {
    "Front": "...",
    "Back": "..."
  },
  ...
]
```

### Step 4B: Verify JSON validity

```bash
# Validate JSON syntax
python3 -c "import json; json.load(open('codemap/<system-id>/anki-cards.json'))" && echo "Valid JSON"

# Count cards
python3 -c "import json; cards=json.load(open('codemap/<system-id>/anki-cards.json')); print(f'Total cards: {len(cards)}')"
```

---

## Output Summary

```markdown
# Anki Card Generation Complete

## System: <system-id>

## Card Statistics
- Context & External Systems: X cards
- Containers & Technology: Y cards
- Components: Z cards
- Code Patterns: W cards
- Cross-Cutting Concepts: V cards
- **Total: N cards**

## Output File
`codemap/<system-id>/anki-cards.json`

## Coverage
- [x] System purpose and boundaries
- [x] External integrations
- [x] Container responsibilities
- [x] Technology stack
- [x] Component modules
- [x] Key classes
- [x] Design patterns
- [x] Class relationships

## Import to Anki
1. Install Anki desktop app
2. Install "Import JSON" add-on or use built-in import
3. Import `codemap/<system-id>/anki-cards.json`
4. Map "Front" to Front field, "Back" to Back field
```

---

## Error Handling

**If no codemap exists:**
- Report that `/viz/c4-map` must be run first
- Do not generate generic cards

**If codemap is incomplete:**
- Generate cards for available documentation only
- Note which levels are missing
- Suggest running `/viz/c4-verify` first

**If synthesis finds quality issues:**
- Report problematic cards
- Auto-fix where possible
- Flag cards needing manual review
